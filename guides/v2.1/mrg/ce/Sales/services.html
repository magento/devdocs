<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Magento_Sales module API</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">
	<meta http-equiv="last-modified" content="" />

	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,700,600,300,800' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="/css/app.css" />
	<link rel="stylesheet" href="/css/print.css" media="print" />
	<link rel="canonical" href="//guides/v2.1/mrg/ce/Sales/services.html">

  <script>
    var baseUrl = "/";
  </script>

	<!-- crazyegg -->
	<script type="text/javascript">
	setTimeout(function(){var a=document.createElement("script");
	var b=document.getElementsByTagName("script")[0];
	a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0038/0321.js?"+Math.floor(new Date().getTime()/3600000);
	a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
	</script>

</head>
<body>

<header class="site-header">

	<nav id="global-nav">

		<div class="menu-btn"><a class="menu-trigger menu-icon" href="#"></a></div>

		<div class="container">

			<a class="logo" href="/"><img src="/i/m-logo.svg" alt=""><img src="/i/magento-logo.svg" alt="Magento" class="magento-logo" /><img src="/i/devdocs-logo.svg" alt="Devdocs" class="devdocs-logo" /></a>

			
<div class="version-switcher dropdown">
	<button class="btn dropdown-toggle" data-toggle="dropdown">
		Magento 2.1
	</button>

	<ul class="dropdown-menu dropdown-menu-left">
	
		<li><a class="dropdown-item" href="/guides/v2.0/mrg/ce/Sales/services.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" href="/guides/v2.1/mrg/ce/Sales/services.html">Magento 2.1</a></li>
	
  </ul>

</div>



			<!-- Main Navigation -->
<div class="nav-main">
  <ul>
    <li class="first">
      <a href="#">Setup and Deployment</a>
        <ul class="menu nav">
            <li><a href="/guides/v2.1/install-gde/bk-install-guide.html">Installation Guide</a></li>
          
          <li class="leaf"><a href="/guides/v2.1/comp-mgr/bk-compman-upgrade-guide.html">Component Manager and System Upgrade Guide</a></li>
          
          <li class="leaf"><a href="/guides/v2.1/config-guide/bk-config-guide.html">Configuration Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/migration/bk-migration-guide.html">Migration Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/cloud/bk-cloud.html">Enterprise Cloud Edition Guide</a></li>
          <li class="leaf"><a href="/magento-release-information.html">Release Information</a></li>
        </ul>
    </li>

    <li>
        <a href="#">Development</a>
        <ul class="menu nav">
          <li class="leaf"><a href="/guides/v2.1/extension-dev-guide/bk-extension-dev-guide.html">PHP Developer Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/ext-best-practices/bk-ext-best-practices.html">Extension Developer Best Practices</a></li>
          <li><a href="/guides/v2.1/payments-integrations/bk-payments-integrations.html">Payments Integrations</a></li>
          <li class="leaf"><a href="/guides/v2.1/architecture/bk-architecture.html">Magento Architecture</a></li>
          <li class="leaf"><a href="/guides/v2.1/mrg/intro.html">Module Reference Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/coding-standards/bk-coding-standards.html">Coding Standards</a></li>
          
          <li class="leaf"><a href="/guides/v2.1/extension-dev-guide/staging.html">Staging</a></li>
          
          <li class="first leaf"><a href="/guides/v2.1/contributor-guide/contributing.html">Contributor Guide</a></li>
        </ul>
    </li>

    <li>
        <a href="#">Frontend</a>
        <ul class="menu nav">
          <li class="first leaf"><a href="/guides/v2.1/frontend-dev-guide/bk-frontend-dev-guide.html">Frontend Developer Guide</a></li>
          
          <li class="leaf"><a href="/guides/v2.1/ui_comp_guide/bk-ui_comps.html">UI Components Guide</a></li>
          
          <li class="leaf"><a href="/guides/v2.1/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript Developer Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/pattern-library/bk-pattern.html">Admin Design Pattern Library</a></li>
          <li class="leaf"><a href="/guides/v2.1/design-styleguide/bk-styleguide.html">Admin Style Guide</a></li>
        </ul>
    </li>

    <li>
        <a href="#">API</a>
        <ul class="menu nav">
          <li class="leaf"><a href="/guides/v2.1/get-started/bk-get-started-api.html">Get Started with Magento Web APIs</a></li>
          <li class="leaf"><a href="/guides/v2.1/rest/bk-rest.html">REST API Reference</a></li>
          <li class="leaf"><a href="/guides/v2.1/soap/bk-soap.html">SOAP API Reference</a></li>
        </ul>
    </li>

    <li>
        <a href="#">Testing</a>
        <ul class="menu nav">
          <li class="leaf"><a href="/guides/v2.1/test/testing.html">Magento Testing Guide</a></li>
          <li class="leaf"><a href="/guides/v2.1/mtf/mtf_introduction.html">Functional Testing</a></li>
          <li class="leaf"><a href="/guides/v2.1/test/integration/integration_test_execution.html">Integration Testing</a></li>
          <li class="leaf"><a href="/guides/v2.1/test/js/jasmine.html">JavaScript Unit Testing</a></li>
          <li class="leaf"><a href="/guides/v2.1/test/unit/unit_test_execution.html">PHP Unit Testing</a></li>
          <li class="leaf"><a href="/guides/v2.1/get-started/web-api-functional-testing.html">Web API Functional Testing</a></li>
        </ul>
    </li>

    <li>
      <a href="/guides/v2.1/howdoi/bk-how-do-i.html">How Tos</a>
    </li>
  </ul>
</div><!-- /.nav-main -->


			<div class="search-btn">
				<a class="search-trigger search-icon" href="/search.html"></a>
			</div>

			<form class="quick-search" action="/search.html" method="get">
				<input type="search" name="q" placeholder="Search" />
				<a href="#" class="quick-search-close">&times;</a>
			</form>





		</div>

	</nav><!-- #global-nav -->

</header>
<div class="nav-main-fader"></div>


<div id="gl-wrapper">

	<!-- .main-container -->
	<div class="main-container">
		<a id="main-content"></a>


<div class="container">

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" class="toc-toggler">Table of Contents</a>
	<div class="sidebar-wrapper">






		<ul>

		

		

				

			

				

			

				

			

				

					
					

					

						

						

							


								


								
									<li class="level1 "><a class="nav-header" href="/guides/v2.1/mrg/intro.html">INTRODUCTION</a></li>
									
								

									


								




						

					

						

						

							


								


								

									

										<li class="levela1"><span class="nav-header">Community Edition</span></li>

									


								

									

										<li class="level3Parent " id="Sales"><a href="#">Sales</a>


									

								

									


											<li class="level3Child Sales " data-menunode="Sales"><a href="/guides/v2.1/mrg/ce/Sales/description.html">Description</a>


									

								

									


											<li class="level3Child Sales " data-menunode="Sales"><a href="/guides/v2.1/mrg/ce/Sales/dependencies.html">Dependencies</a>


									

								

									


											<li class="level3Child Sales  active " data-menunode="Sales"><a href="/guides/v2.1/mrg/ce/Sales/services.html">Services/API</a>


									

								




						

					

						

						

							


								


								

									

										<li class="levela1"><span class="nav-header">Enterprise Edition</span></li>

									


								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/BundleStaging.html">BundleStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CatalogImportExportStaging.html">CatalogImportExportStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CatalogInventoryStaging.html">CatalogInventoryStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CatalogRuleStaging.html">CatalogRuleStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CatalogStaging.html">CatalogStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CatalogUrlRewriteStaging.html">CatalogUrlRewriteStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CheckoutStaging.html">CheckoutStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/CmsStaging.html">CmsStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/ConfigurableProductStaging.html">ConfigurableProductStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/DownloadableStaging.html">DownloadableStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/GiftCardStaging.html">GiftCardStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/GiftMessageStaging.html">GiftMessageStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/GiftWrappingStaging.html">GiftWrappingStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/GoogleOptimizerStaging.html">GoogleOptimizerStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/GroupedProductStaging.html">GroupedProductStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/LayeredNavigationStaging.html">LayeredNavigationStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/MsrpStaging.html">MsrpStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/PaymentStaging.html">PaymentStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/ProductVideoStaging.html">ProductVideoStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/ReviewStaging.html">ReviewStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/RmaStaging.html">RmaStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/SalesRuleStaging.html">SalesRuleStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/SearchStaging.html">SearchStaging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/Staging.html">Staging</a></li>

									

								

									

									<li class="level-2 "><a href="/guides/v2.1/mrg/ee/WeeeStaging.html">WeeeStaging</a></li>

									

								




						

					


				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

				

			

		</ul>

	</div>
</aside>
<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <a class="breadcrumb-item" href="/"><span>Home</span></a>

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

    <!-- Iteration breadcrumb item -->
    
    
    

      <!-- Skip if root -->
      


      <!-- Get breadcrumb title. Insert snippet from configuration description to translates breadcrumb if language plugin is installed and YAML subset is set -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
        <a property="item" typeof="WebPage" href="/guides/v2.1/mrg/intro.html"><span property="name">Module Reference Guide</span></a>
        <meta property="position" content="1" />
      </li>

    

      <!-- Skip if root -->
      


      <!-- Get breadcrumb title. Insert snippet from configuration description to translates breadcrumb if language plugin is installed and YAML subset is set -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">
        <span property="name">Magento_Sales module API</span>
        <meta property="position" content="2" />
      </li>

    

    </ol>

  </nav>


	
	<h1 class="page-heading">Magento_Sales module API</h1>

  

<div class="tabs-container">
    
    <div class="tab " id="">
        <a href="/guides/v2.1/mrg/ce/Sales/description.html">Description</a>
    </div>
    
    <div class="tab " id="">
        <a href="/guides/v2.1/mrg/ce/Sales/dependencies.html">Dependencies</a>
    </div>
    
    <div class="tab current-tab" id="">
        <a href="/guides/v2.1/mrg/ce/Sales/services.html">Services/APIs</a>
    </div>
    
</div>



</section>

			<h2 id="invoiceorder">InvoiceOrder</h2>

<h3 id="description">Description</h3>

<p>The InvoiceOrder service introduces a capability to execute Magento native business flow of the Sales module using API.</p>

<p>With this service you can:</p>

<ul>
  <li>create an invoice document (full or partial)</li>
  <li>capture money placed with order payment</li>
  <li>notify a customer about document creation</li>
  <li>change order status and state</li>
</ul>

<h3 id="parameters">Parameters</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>Format</th>
      <th>Example</th>
      <th>Required / Optional</th>
      <th>Default value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>orderId</code></td>
      <td>An identifier of a target order for operation.</td>
      <td>Integer</td>
      <td>&nbsp;</td>
      <td>Required</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><code>items</code></td>
      <td>An array of order items that will be included to invoice. By default, the invoice will contain all order items.</td>
      <td>Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceItemCreationInterface.php"><code>\Magento\Sales\Api\Data\InvoiceItemCreationInterface</code></a>.</td>
      <td>
      
<figure class="highlight"><pre><code class="language-json" data-lang="json">      <span class="p">[</span>
          <span class="p">{</span>
              <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">2</span>
          <span class="p">},</span>
          <span class="p">{</span>
          <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
          <span class="p">}</span>
          <span class="p">]</span>
      </code></pre></figure>

      </td>
      <td>Optional (required, when invoice must contain particular order items.</td>
      <td><code>[]</code></td>
    </tr>
    <tr>
      <td><code>capture</code></td>
      <td>Flag that sets whether the customer’s payment can be captured using an online payments system (for example, PayPal). <strong>IMPORTANT: If you created Invoice with the flag set to default value (<code>false</code>), you will not be able to capture money in Magento on the corresponding Invoice.</strong></td>
      <td>Boolean</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>notify</code></td>
      <td>Flag that activates e-mail notification about new invoice for a customer. If <code>true</code>, the service will notify a customer. If <code>false</code>, the service won’t notify a customer.</td>
      <td>Boolean</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>appendComment</code></td>
      <td>Flag that determines whether a <code>comment</code> argument must be included in an e-mail notification. If <code>true</code>, the service adds the comment.</td>
      <td>Boolean</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>comment</code></td>
      <td>The comment to add to an invoice. Specify a comment if <code>appendComment</code> is set to <code>true</code>.</td>
      <td>A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceCommentCreationInterface.php"><code>\Magento\Sales\Api\Data\InvoiceCommentCreationInterface</code></a>.</td>
      <td>
      
<figure class="highlight"><pre><code class="language-json" data-lang="json">      <span class="p">{</span>
          <span class="nt">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;The first Invoice&quot;</span><span class="p">,</span>
          <span class="nt">&quot;is_visible_on_front&quot;</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
      </code></pre></figure>

      </td>
      <td>Optional</td>
      <td><code>null</code></td>
    </tr>
    <tr>
      <td><code>arguments</code></td>
      <td>Additional arguments. Reserved for use by extension modules.</td>
      <td>A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceCreationArgumentsInterface.php"><code>\Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</code></a>.</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>null</code></td>
    </tr>
  </tbody>
</table>

<h3 id="return-values">Return values</h3>

<p>The service returns an identifier of the created Invoice.</p>

<h3 id="rest">REST</h3>

<h4 id="post-endpoint">POST Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/invoice</code></p>

<h4 id="rest-declaration">REST declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code>etc/webapi.xml</code></a></p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">&quot;/V1/order/:orderId/invoice&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">&quot;Magento\Sales\Api\InvoiceOrderInterface&quot;</span> <span class="na">method=</span><span class="s">&quot;execute&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">&quot;Magento_Sales::sales&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span></code></pre></figure>

<h3 id="soap">SOAP</h3>

<h4 id="soap-endpoint">SOAP Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesInvoiceOrderV1</code></p>

<h3 id="php-interface">PHP interface</h3>

<p><code>\Magento\Sales\Api\InvoiceOrderInterface</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>

<span class="k">namespace</span> <span class="nx">Magento\Sales\Api</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class InvoiceOrderInterface</span>
<span class="sd"> *</span>
<span class="sd"> * @api</span>
<span class="sd"> */</span>
<span class="k">interface</span> <span class="nx">InvoiceOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @param int $orderId</span>
<span class="sd">     * @param bool|false $capture</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\InvoiceItemCreationInterface[] $items</span>
<span class="sd">     * @param bool|false $notify</span>
<span class="sd">     * @param bool|false $appendComment</span>
<span class="sd">     * @param Data\InvoiceCommentCreationInterface|null $comment</span>
<span class="sd">     * @param Data\InvoiceCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="nv">$capture</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\InvoiceCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h3 id="php-implementation">PHP implementation</h3>

<p><code>\Magento\Sales\Model\InvoiceOrder</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide included code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>

<span class="k">namespace</span> <span class="nx">Magento\Sales\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\Data\InvoiceCommentCreationInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\InvoiceOrderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nx">OrderConfig</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Invoice\InvoiceValidatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Invoice\NotifierInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\InvoiceDocumentFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\InvoiceRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderValidatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\PaymentAdapterInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Validation\InvoiceOrderInterface</span> <span class="k">as</span> <span class="nx">InvoiceOrderValidator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Framework\App\ObjectManager</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class InvoiceOrder</span>
<span class="sd"> * @SuppressWarnings(PHPMD.CouplingBetweenObjects)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">InvoiceOrder</span> <span class="k">implements</span> <span class="nx">InvoiceOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var ResourceConnection</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var InvoiceDocumentFactory</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var PaymentAdapterInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$paymentAdapter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderStateResolverInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderConfig</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var InvoiceRepository</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var InvoiceOrderValidator</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$invoiceOrderValidator</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var NotifierInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$notifierInterface</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var LoggerInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * InvoiceOrder constructor.</span>
<span class="sd">     * @param ResourceConnection $resourceConnection</span>
<span class="sd">     * @param OrderRepositoryInterface $orderRepository</span>
<span class="sd">     * @param InvoiceDocumentFactory $invoiceDocumentFactory</span>
<span class="sd">     * @param InvoiceValidatorInterface $invoiceValidator</span>
<span class="sd">     * @param OrderValidatorInterface $orderValidator</span>
<span class="sd">     * @param PaymentAdapterInterface $paymentAdapter</span>
<span class="sd">     * @param OrderStateResolverInterface $orderStateResolver</span>
<span class="sd">     * @param OrderConfig $config</span>
<span class="sd">     * @param InvoiceRepository $invoiceRepository</span>
<span class="sd">     * @param NotifierInterface $notifierInterface</span>
<span class="sd">     * @param LoggerInterface $logger</span>
<span class="sd">     * @param InvoiceOrderValidator|null $invoiceOrderValidator</span>
<span class="sd">     * @SuppressWarnings(PHPMD.ExcessiveParameterList)</span>
<span class="sd">     * @SuppressWarnings(PHPMD.UnusedFormalParameter)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="nx">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="nx">InvoiceDocumentFactory</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">,</span>
        <span class="nx">InvoiceValidatorInterface</span> <span class="nv">$invoiceValidator</span><span class="p">,</span>
        <span class="nx">OrderValidatorInterface</span> <span class="nv">$orderValidator</span><span class="p">,</span>
        <span class="nx">PaymentAdapterInterface</span> <span class="nv">$paymentAdapter</span><span class="p">,</span>
        <span class="nx">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="nx">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="nx">InvoiceRepository</span> <span class="nv">$invoiceRepository</span><span class="p">,</span>
        <span class="nx">NotifierInterface</span> <span class="nv">$notifierInterface</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="nx">InvoiceOrderValidator</span> <span class="nv">$invoiceOrderValidator</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceDocumentFactory</span> <span class="o">=</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">paymentAdapter</span> <span class="o">=</span> <span class="nv">$paymentAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceRepository</span> <span class="o">=</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifierInterface</span> <span class="o">=</span> <span class="nv">$notifierInterface</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceOrderValidator</span> <span class="o">=</span> <span class="nv">$invoiceOrderValidator</span> <span class="o">?:</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
            <span class="nx">InvoiceOrderValidator</span><span class="o">::</span><span class="na">class</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @param int $orderId</span>
<span class="sd">     * @param bool $capture</span>
<span class="sd">     * @param array $items</span>
<span class="sd">     * @param bool $notify</span>
<span class="sd">     * @param bool $appendComment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\InvoiceCommentCreationInterface|null $comment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int</span>
<span class="sd">     * @throws \Magento\Sales\Api\Exception\DocumentValidationExceptionInterface</span>
<span class="sd">     * @throws \Magento\Sales\Api\Exception\CouldNotInvoiceExceptionInterface</span>
<span class="sd">     * @throws \Magento\Framework\Exception\InputException</span>
<span class="sd">     * @throws \Magento\Framework\Exception\NoSuchEntityException</span>
<span class="sd">     * @throws \DomainException</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="nv">$capture</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">InvoiceCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">InvoiceCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">(</span><span class="s1">&#39;sales&#39;</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceDocumentFactory</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$errorMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceOrderValidator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$capture</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$errorMessages</span><span class="o">-&gt;</span><span class="na">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s2">&quot;Invoice Document Validation Error(s):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$errorMessages</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">paymentAdapter</span><span class="o">-&gt;</span><span class="na">pay</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$invoice</span><span class="p">,</span> <span class="nv">$capture</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span><span class="o">-&gt;</span><span class="na">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[</span><span class="nx">OrderStateResolverInterface</span><span class="o">::</span><span class="na">IN_PROGRESS</span><span class="p">])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="na">getState</span><span class="p">()));</span>
            <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span><span class="nx">\Magento\Sales\Model\Order\Invoice</span><span class="o">::</span><span class="na">STATE_PAID</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$invoice</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\CouldNotInvoiceException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Could not save an invoice, see error log for details&#39;</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifierInterface</span><span class="o">-&gt;</span><span class="na">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$invoice</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="exceptions">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Creditmemo Document Validation Error(s):\nWe can&#39;t create creditmemo for the order.\nThe most money available to refund is 0.&quot;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="extension-points">Extension points</h4>

<p>The service implementation contains extension points marked with <code>@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface which provides a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/InvoiceRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\InvoiceRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Shipments.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/InvoiceDocumentFactory.php" target="_blank"><code>\Magento\Sales\Model\Order\InvoiceDocumentFactory</code></a></td>
      <td>A factory for creating an Invoice data object. The factory uses the <code>arguments</code> parameter to process the extension attributes of a new Invoice.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Invoice/NotifierInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Invoice\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Invoice creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/InvoiceOrderInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Validation\InvoiceOrderInterface</code></a></td>
      <td>An interface for validating service parameters and Invoice data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/PaymentAdapterInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\PaymentAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="refundinvoice">RefundInvoice</h2>

<h3 id="description-1">Description</h3>

<p>The RefundInvoice service introduces a capability to execute Magento native business flow of the Sales module using API.</p>

<p>Please note, that current service is available only for invoices created using online payment methods. If you try to apply it to an Invoice created using offline payment method, system will throw a validation error.</p>

<p>With this service you can:</p>

<ul>
  <li>create a Credit Memo (complete or partial) for particular Invoice</li>
  <li>add details about refunded items to an Order</li>
  <li>change status and state of an Order according to performed actions</li>
  <li>notify a customer about performed refund operation</li>
</ul>

<h3 id="service-parameters">Service parameters</h3>

<table>
  <thead>
    <tr>
      <th>
        Name
      </th>
      <th>
        Description
      </th>
      <th>
        Format
      </th>
      <th>
        Example
      </th>
      <th>
        Required/Optional
      </th>
      <th>
        Default value
      </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <code>invoiceId</code>
      </td>
      <td>
        An identifier of a target Invoice for operation.
      </td>
      <td>
        Integer
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Required
      </td>
      <td>
        &nbsp;
      </td>
    </tr>
    <tr>
      <td>
        <code>items</code>
      </td>
      <td>
        An array of invoice items included to a Credit Memo. By
        default, the service will create a Credit Memo for all
        invoice items.
      </td>
      <td>
        Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoItemCreationInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoItemCreationInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">[</span>
            <span class="p">{</span>
                 <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
            <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
            <span class="p">}</span>
        <span class="p">]</span>
        </code></pre></figure>

      </td>
      <td>
        Optional (required, when a Credit Memo must contain
        particular order items)
      </td>
      <td>
        <code>[]</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>isOnline</code>
      </td>
      <td>
        Flag that determines whether funds should be returned to a
        customer via online payment system (PayPal for example) or
        not.
      </td>
      <td>
        Boolean
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>false</code>
      </td>
    </tr>
    <tr>
      <td></td>
    </tr>
    <tr>
      <td>
        <code>notify</code>
      </td>
      <td>
        Flag that activates e-mail notification about Credit Memo
        creation. If <code>true</code>, the service notifies a
        customer; if <code>false</code>, it doesn't.
      </td>
      <td>
        Boolean
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>false</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>appendComment</code>
      </td>
      <td>
        Flag that activates addition of a <code>comment</code>
        argument to the e-mail notification. If <code>true</code>
        and <code>comment</code> contains data, the service will
        add the comment to an e-mail notification.
      </td>
      <td>
        Boolean
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>false</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>comment</code>
      </td>
      <td>
        A comment to Credit Memo.
      </td>
      <td>
        A format according to the <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">{</span>
            <span class="nt">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;The first Credit Memo&quot;</span><span class="p">,</span>
            <span class="nt">&quot;is_visible_on_front&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
        </code></pre></figure>

      </td>
      <td>
        Optional
      </td>
      <td>
        <code>null</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>arguments</code>
      </td>
      <td>
        Additional arguments for the service. Can be used by
        extension modules.
      </td>
      <td>
        A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">{</span>
        <span class="nt">&quot;shipping_amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span>
        <span class="nt">&quot;adjustment_positive&quot;</span><span class="p">:</span> <span class="mf">5.00</span><span class="p">,</span>
        <span class="nt">&quot;adjustment_negative&quot;</span><span class="p">:</span> <span class="mf">5.00</span>
        <span class="p">}</span>
        </code></pre></figure>

        A parameter <code>shipping_amount</code>
        behaves like at the Credit Memo creation page in the Admin
        area. If shipping amount is not specified, then shipping
        amount from a target Invoice is refunded automatically. To
        specify a shipping amount, consider shipping tax displays
        settings.
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>null</code>
      </td>
    </tr>
  </tbody>
</table>

<h3 id="return-values-1">Return values</h3>

<p>The service returns an identifier of a created Credit Memo.</p>

<h3 id="rest-1">REST</h3>

<h4 id="post-endpoint-1">POST Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;invoiceId&gt;/refund</code></p>

<h4 id="rest-declaration-1">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code>etc/webapi.xml</code></a></p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">&quot;/V1/invoice/:invoiceId/refund&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">&quot;Magento\Sales\Api\RefundInvoiceInterface&quot;</span> <span class="na">method=</span><span class="s">&quot;execute&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">&quot;Magento_Sales::sales&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span></code></pre></figure>

<h3 id="soap-1">SOAP</h3>

<h4 id="soap-endpoint-1">SOAP Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesRefundInvoiceV1</code></p>

<h3 id="php-interface-1">PHP interface</h3>

<p><code>\Magento\Sales\Api\RefundInvoiceInterface</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Api</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Interface RefundInvoiceInterface</span>
<span class="sd"> */</span>
<span class="k">interface</span> <span class="nx">RefundInvoiceInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Create refund for invoice</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $invoiceId</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoItemCreationInterface[] $items</span>
<span class="sd">     * @param bool|null $isOnline</span>
<span class="sd">     * @param bool|null $notify</span>
<span class="sd">     * @param bool|null $appendComment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoCommentCreationInterface|null $comment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$invoiceId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$isOnline</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h3 id="php-implementation-1">PHP implementation</h3>

<p><code>\Magento\Sales\Model\RefundInvoice</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\CreditmemoRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\InvoiceRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\RefundInvoiceInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nx">OrderConfig</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Creditmemo\NotifierInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\CreditmemoDocumentFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Validation\RefundInvoiceInterface</span> <span class="k">as</span> <span class="nx">RefundInvoiceValidator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\RefundAdapterInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class RefundInvoice</span>
<span class="sd"> * @SuppressWarnings(PHPMD.CouplingBetweenObjects)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">RefundInvoice</span> <span class="k">implements</span> <span class="nx">RefundInvoiceInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var ResourceConnection</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderStateResolverInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var InvoiceRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var CreditmemoRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var RefundAdapterInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$refundAdapter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var CreditmemoDocumentFactory</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var NotifierInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$notifier</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderConfig</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var LoggerInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var RefundInvoiceValidator</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$validator</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * RefundInvoice constructor.</span>
<span class="sd">     *</span>
<span class="sd">     * @param ResourceConnection $resourceConnection</span>
<span class="sd">     * @param OrderStateResolverInterface $orderStateResolver</span>
<span class="sd">     * @param OrderRepositoryInterface $orderRepository</span>
<span class="sd">     * @param InvoiceRepositoryInterface $invoiceRepository</span>
<span class="sd">     * @param RefundInvoiceValidator $validator</span>
<span class="sd">     * @param CreditmemoRepositoryInterface $creditmemoRepository</span>
<span class="sd">     * @param RefundAdapterInterface $refundAdapter</span>
<span class="sd">     * @param CreditmemoDocumentFactory $creditmemoDocumentFactory</span>
<span class="sd">     * @param NotifierInterface $notifier</span>
<span class="sd">     * @param OrderConfig $config</span>
<span class="sd">     * @param LoggerInterface $logger</span>
<span class="sd">     * @SuppressWarnings(PHPMD.ExcessiveParameterList)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="nx">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="nx">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="nx">InvoiceRepositoryInterface</span> <span class="nv">$invoiceRepository</span><span class="p">,</span>
        <span class="nx">RefundInvoiceValidator</span> <span class="nv">$validator</span><span class="p">,</span>
        <span class="nx">CreditmemoRepositoryInterface</span> <span class="nv">$creditmemoRepository</span><span class="p">,</span>
        <span class="nx">RefundAdapterInterface</span> <span class="nv">$refundAdapter</span><span class="p">,</span>
        <span class="nx">CreditmemoDocumentFactory</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">,</span>
        <span class="nx">NotifierInterface</span> <span class="nv">$notifier</span><span class="p">,</span>
        <span class="nx">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceRepository</span> <span class="o">=</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoRepository</span> <span class="o">=</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">refundAdapter</span> <span class="o">=</span> <span class="nv">$refundAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoDocumentFactory</span> <span class="o">=</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifier</span> <span class="o">=</span> <span class="nv">$notifier</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @inheritdoc</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$invoiceId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$isOnline</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">(</span><span class="s1">&#39;sales&#39;</span><span class="p">);</span>
        <span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceRepository</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">getOrderId</span><span class="p">());</span>
        <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoDocumentFactory</span><span class="o">-&gt;</span><span class="na">createFromInvoice</span><span class="p">(</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>

        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$creditmemo</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$isOnline</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s2">&quot;Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span><span class="nx">\Magento\Sales\Model\Order\Creditmemo</span><span class="o">::</span><span class="na">STATE_REFUNDED</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setCustomerNoteNotify</span><span class="p">(</span><span class="nv">$notify</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">refundAdapter</span><span class="o">-&gt;</span><span class="na">refund</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$isOnline</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span><span class="o">-&gt;</span><span class="na">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="na">getState</span><span class="p">()));</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$isOnline</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">setIsUsedForRefund</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">setBaseTotalRefunded</span><span class="p">(</span>
                    <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">getBaseTotalRefunded</span><span class="p">()</span> <span class="o">+</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="na">getBaseGrandTotal</span><span class="p">()</span>
                <span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">invoiceRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$invoice</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\CouldNotRefundException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Could not save a Creditmemo, see error log for details&#39;</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifier</span><span class="o">-&gt;</span><span class="na">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="na">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="exceptions-1">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Creditmemo Document Validation Error(s):\nWe can&#39;t create creditmemo for the order.\nThe most money available to refund is 0.&quot;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="extension-points-1">Extension points</h4>

<p>The service contains extension points marked with <code>@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/InvoiceRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\InvoiceRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Invoices.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/CreditmemoRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\CreditmemoRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Credit Memos.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/CreditmemoDocumentFactory.php" target="_blank"><code>\Magento\Sales\Model\Order\CreditmemoDocumentFactory</code></a></td>
      <td>A factory for creating an Credit Memo data object. The factory uses the <code>arguments</code> parameter to process the extension attributes of a new Credit Memo.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Creditmemo\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Credit Memo creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/RefundInvoiceInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Validation\RefundInvoiceInterface</code></a></td>
      <td>An interface for validating service parameters and Credit Memo data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/RefundAdapterInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\RefundAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="refundorder">RefundOrder</h2>

<h3 id="description-2">Description</h3>

<p>With the RefundOrder service you can:</p>

<ul>
  <li>create a Credit Memo (complete or partial) for a particular Order</li>
  <li>add details about refunded items to an Order</li>
  <li>change status and state of an Order according to performed actions</li>
  <li>notify a customer about performed refund operation</li>
</ul>

<h3 id="service-parameters-1">Service parameters</h3>

<table>
  <thead>
    <tr>
      <th>
        Name
      </th>
      <th>
        Description
      </th>
      <th>
        Format
      </th>
      <th>
        Example
      </th>
      <th>
        Required/Optional
      </th>
      <th>
        Default value
      </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <code>orderId</code>
      </td>
      <td>
        An identifier of a target Order for operation.
      </td>
      <td>
        Integer
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Required
      </td>
      <td>
        &nbsp;
      </td>
    </tr>
    <tr>
      <td>
        <code>items</code>
      </td>
      <td>
        An array of Order items included to a Credit Memo. By
        default, the service will create a Credit Memo for all
        Order items.
      </td>
      <td>
        Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoItemCreationInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoItemCreationInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">[</span>
            <span class="p">{</span>
                 <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
                 <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
            <span class="p">}</span>
        <span class="p">]</span>
        </code></pre></figure>

      </td>
      <td>
        Optional (required, when a Credit Memo must contain
        particular order items)
      </td>
      <td>
        <code>[]</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>notify</code>
      </td>
      <td>
        Flag that activates e-mail notification about Credit Memo
        creation. If <code>true</code>, the service notifies a
        customer; if <code>false</code>, it doesn't.
      </td>
      <td>
        Boolean
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>false</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>appendComment</code>
      </td>
      <td>
        Flag that activates addition of a <code>comment</code>
        argument to the e-mail notification. If <code>true</code>
        and <code>comment</code> contains data, the service will
        add the comment to an e-mail notification.
      </td>
      <td>
        Boolean
      </td>
      <td>
        &nbsp;
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>false</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>comment</code>
      </td>
      <td>
        A comment to Credit Memo.
      </td>
      <td>
        A format according to the <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">{</span>
            <span class="nt">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;The first Credit Memo&quot;</span><span class="p">,</span>
            <span class="nt">&quot;is_visible_on_front&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
        </code></pre></figure>

      </td>
      <td>
        Optional
      </td>
      <td>
        <code>null</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>arguments</code>
      </td>
      <td>
        Additional arguments for the service. Can be used by
        extension modules.
      </td>
      <td>
        A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php">
        <code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>.
      </td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">{</span>
        <span class="nt">&quot;shipping_amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span>
        <span class="nt">&quot;adjustment_positive&quot;</span><span class="p">:</span> <span class="mf">5.00</span><span class="p">,</span>
        <span class="nt">&quot;adjustment_negative&quot;</span><span class="p">:</span> <span class="mf">5.00</span>
        <span class="p">}</span>
        </code></pre></figure>

        A parameter <code>shipping_amount</code>
        behaves like at the Credit Memo creation page in the Admin
        area. If shipping amount is not specified, then shipping
        amount from a target Invoice is refunded automatically. To
        specify a shipping amount, consider shipping tax displays
        settings.
      </td>
      <td>
        Optional
      </td>
      <td>
        <code>null</code>
      </td>
    </tr>
  </tbody>
</table>

<h3 id="return-values-2">Return values</h3>

<p>The service returns an identifier of a created Credit Memo.</p>

<h3 id="rest-2">REST</h3>

<h4 id="post-endpoint-2">POST Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/refund</code></p>

<h4 id="rest-declaration-2">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code>etc/webapi.xml</code></a></p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">&quot;/V1/order/:orderId/refund&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">&quot;Magento\Sales\Api\RefundOrderInterface&quot;</span> <span class="na">method=</span><span class="s">&quot;execute&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">&quot;Magento_Sales::sales&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span></code></pre></figure>

<h3 id="soap-2">SOAP</h3>

<h4 id="soap-endpoint-2">SOAP Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesRefundOrderV1</code></p>

<h3 id="php-interface-2">PHP interface</h3>

<p><code>\Magento\Sales\Api\RefundOrderInterface</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Api</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Interface RefundOrderInterface</span>
<span class="sd"> */</span>
<span class="k">interface</span> <span class="nx">RefundOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Create offline refund for order</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $orderId</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoItemCreationInterface[] $items</span>
<span class="sd">     * @param bool|null $notify</span>
<span class="sd">     * @param bool|null $appendComment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoCommentCreationInterface|null $comment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h3 id="php-implementation-2">PHP implementation</h3>

<p><code>\Magento\Sales\Model\RefundOrder</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\CreditmemoRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\RefundOrderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nx">OrderConfig</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Creditmemo\NotifierInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\CreditmemoDocumentFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\RefundAdapterInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Validation\RefundOrderInterface</span> <span class="k">as</span> <span class="nx">RefundOrderValidator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class RefundOrder</span>
<span class="sd"> * @SuppressWarnings(PHPMD.CouplingBetweenObjects)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">RefundOrder</span> <span class="k">implements</span> <span class="nx">RefundOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var ResourceConnection</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderStateResolverInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var CreditmemoRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var RefundAdapterInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$refundAdapter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var CreditmemoDocumentFactory</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var RefundOrderValidator</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$validator</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var NotifierInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$notifier</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderConfig</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var LoggerInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * RefundOrder constructor.</span>
<span class="sd">     *</span>
<span class="sd">     * @param ResourceConnection $resourceConnection</span>
<span class="sd">     * @param OrderStateResolverInterface $orderStateResolver</span>
<span class="sd">     * @param OrderRepositoryInterface $orderRepository</span>
<span class="sd">     * @param CreditmemoRepositoryInterface $creditmemoRepository</span>
<span class="sd">     * @param RefundAdapterInterface $refundAdapter</span>
<span class="sd">     * @param CreditmemoDocumentFactory $creditmemoDocumentFactory</span>
<span class="sd">     * @param RefundOrderValidator $validator</span>
<span class="sd">     * @param NotifierInterface $notifier</span>
<span class="sd">     * @param OrderConfig $config</span>
<span class="sd">     * @param LoggerInterface $logger</span>
<span class="sd">     * @SuppressWarnings(PHPMD.ExcessiveParameterList)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="nx">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="nx">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="nx">CreditmemoRepositoryInterface</span> <span class="nv">$creditmemoRepository</span><span class="p">,</span>
        <span class="nx">RefundAdapterInterface</span> <span class="nv">$refundAdapter</span><span class="p">,</span>
        <span class="nx">CreditmemoDocumentFactory</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">,</span>
        <span class="nx">RefundOrderValidator</span> <span class="nv">$validator</span><span class="p">,</span>
        <span class="nx">NotifierInterface</span> <span class="nv">$notifier</span><span class="p">,</span>
        <span class="nx">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoRepository</span> <span class="o">=</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">refundAdapter</span> <span class="o">=</span> <span class="nv">$refundAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoDocumentFactory</span> <span class="o">=</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifier</span> <span class="o">=</span> <span class="nv">$notifier</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @inheritdoc</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">(</span><span class="s1">&#39;sales&#39;</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoDocumentFactory</span><span class="o">-&gt;</span><span class="na">createFromOrder</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$creditmemo</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s2">&quot;Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span><span class="nx">\Magento\Sales\Model\Order\Creditmemo</span><span class="o">::</span><span class="na">STATE_REFUNDED</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setCustomerNoteNotify</span><span class="p">(</span><span class="nv">$notify</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">refundAdapter</span><span class="o">-&gt;</span><span class="na">refund</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span><span class="o">-&gt;</span><span class="na">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="na">getState</span><span class="p">()));</span>

            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">creditmemoRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\CouldNotRefundException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Could not save a Creditmemo, see error log for details&#39;</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifier</span><span class="o">-&gt;</span><span class="na">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="na">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="exceptions-2">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Creditmemo Document Validation Error(s):\nWe can&#39;t create creditmemo for the order.\nThe most money available to refund is 0.&quot;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="extension-points-2">Extension points</h4>

<p>The service contains extension points marked with <code>@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/CreditmemoRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\CreditmemoRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Credit Memos.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/CreditmemoDocumentFactory.php" target="_blank"><code>\Magento\Sales\Model\Order\CreditmemoDocumentFactory</code></a></td>
      <td>A factory for creating an Credit Memo data object. The factory uses the <code>arguments</code> parameter to process the extension attributes of a new Credit Memo.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Creditmemo\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Credit Memo creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/RefundOrderInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Validation\RefundOrderInterface</code></a></td>
      <td>An interface for validating service parameters and Credit Memo data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/RefundAdapterInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\RefundAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="shiporder">ShipOrder</h2>

<h3 id="description-3">Description</h3>

<p>With the ShipOrder service you can:</p>

<ul>
  <li>create a shipment document (full or partial)</li>
  <li>add details about shipped items into an order</li>
  <li>change status and state of an order according to performed actions</li>
  <li>notify the customer of a new shipment document</li>
</ul>

<h3 id="service-parameters-2">Service parameters</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>Format</th>
      <th>Example</th>
      <th>Required/Optional</th>
      <th>Default value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>orderId</code></td>
      <td>An identifier of a target order for operation.</td>
      <td>Integer</td>
      <td>&nbsp;</td>
      <td>Required</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><code>items</code></td>
      <td>An array of order items included to a shipment. By default, the service will create a shipment for all order items.</td>
      <td>Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentItemCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentItemCreationInterface</code></a>.</td>
      <td>
        
<figure class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;order_item_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
            <span class="p">}</span>
        <span class="p">]</span>
        </code></pre></figure>

      </td>
      <td>Optional (required, when a shipment document must contain particular order items)</td>
      <td><code>[]</code></td>
    </tr>
    <tr>
      <td><code>notify</code></td>
      <td>Flag that activates e-mail notification about shipment details. If <code>true</code>, the service notifies a customer; if <code>false</code>, it doesn't.</td>
      <td>Boolean</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>appendComment</code></td>
      <td>Flag that activates addition of a <code>comment</code> argument to the e-mail notification. If <code>true</code> and <code>comment</code> contains data, the service will add the comment to an e-mail notification.</td>
      <td>Boolean</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>comment</code></td>
      <td>A comment about a shipment.</td>
      <td>A format according to the
        <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php"><code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>
        interface.</td>
      <td>
      
<figure class="highlight"><pre><code class="language-json" data-lang="json">      <span class="p">{</span>   
          <span class="nt">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;The first Invoice&quot;</span><span class="p">,</span>
          <span class="nt">&quot;is_visible_on_front&quot;</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
      </code></pre></figure>

      </td>
      <td> Optional </td>
      <td> <code>null</code> </td>
    </tr>
    <tr>
      <td> <code>tracks</code> </td>
      <td> A list of track numbers attached to a shipment. </td>
      <td> Array of objects with a format according to
        <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentTrackCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentTrackCreationInterface&gt;</code></a>. </td>
      <td>
      
<figure class="highlight"><pre><code class="language-json" data-lang="json">      <span class="p">[</span>
          <span class="p">{</span>
              <span class="nt">&quot;track_number&quot;</span><span class="p">:</span> <span class="s2">&quot;132456789&quot;</span><span class="p">,</span>
              <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;United States Postal Service&quot;</span><span class="p">,</span>
              <span class="nt">&quot;carrier_code&quot;</span><span class="p">:</span> <span class="s2">&quot;usps&quot;</span>
          <span class="p">}</span>
      <span class="p">]</span>
      </code></pre></figure>

      </td>
      <td> Optional </td>
      <td> <code>[]</code> </td>
    </tr>
    <tr>
      <td> <code>packages</code> </td>
      <td> A list of packages attached to a shipment. </td>
      <td> Array of objects with a format according to
        <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentPackageCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentPackageCreationInterface</code></a>. </td>
      <td>
      
<figure class="highlight"><pre><code class="language-json" data-lang="json">      <span class="p">[</span>
          <span class="p">{</span>
              <span class="nt">&quot;extension_attributes&quot;</span><span class="p">:</span>
              <span class="p">{</span>
                  <span class="nt">&quot;ups&quot;</span><span class="p">:</span>
                      <span class="p">{</span>
                          <span class="nt">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                          <span class="nt">&quot;height&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                          <span class="nt">&quot;width&quot;</span><span class="p">:</span> <span class="mi">20</span>
                      <span class="p">}</span>
              <span class="p">}</span>
           <span class="p">}</span>
      <span class="p">]</span>
      </code></pre></figure>

      </td>
      <td>Optional</td>
      <td><code>[]</code></td>
    </tr>
    <tr>
      <td><code>arguments</code></td>
      <td>Additional arguments for the service. Can be used by
        extension modules.</td>
      <td>A format according to the
        <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php"><code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>
        interface.</td>
      <td>&nbsp;</td>
      <td>Optional</td>
      <td><code>null</code></td>
    </tr>
  </tbody>
</table>

<h3 id="return-values-3">Return values</h3>

<p>The service returns the identifier of a created shipment.</p>

<h3 id="rest-3">REST</h3>

<h4 id="post-endpoint-3">POST Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/ship</code></p>

<h4 id="rest-declaration-3">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code>etc/webapi.xml</code></a></p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">&quot;/V1/order/:orderId/ship&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">&quot;Magento\Sales\Api\ShipOrderInterface&quot;</span> <span class="na">method=</span><span class="s">&quot;execute&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">&quot;Magento_Sales::sales&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span></code></pre></figure>

<h3 id="soap-3">SOAP</h3>

<h4 id="soap-endpoint-3">SOAP Endpoint</h4>

<p><code>http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesShipOrderV1</code></p>

<h3 id="php-interface-3">PHP interface</h3>

<p><code>\Magento\Sales\Api\ShipOrderInterface</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Api</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class ShipOrderInterface</span>
<span class="sd"> *</span>
<span class="sd"> * @api</span>
<span class="sd"> */</span>
<span class="k">interface</span> <span class="nx">ShipOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Creates new Shipment for given Order.</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $orderId</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentItemCreationInterface[] $items</span>
<span class="sd">     * @param bool $notify</span>
<span class="sd">     * @param bool $appendComment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentCommentCreationInterface|null $comment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentTrackCreationInterface[] $tracks</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentPackageCreationInterface[] $packages</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int Id of created Shipment.</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\ShipmentCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$tracks</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="k">array</span> <span class="nv">$packages</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">\Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h3 id="php-implementation-3">PHP implementation</h3>

<p><code>\Magento\Sales\Model\ShipOrder</code></p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide a code </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Copyright © 2016 Magento. All rights reserved.</span>
<span class="sd"> * See COPYING.txt for license details.</span>
<span class="sd"> */</span>
<span class="k">namespace</span> <span class="nx">Magento\Sales\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\ShipmentRepositoryInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Api\ShipOrderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nx">OrderConfig</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\OrderValidatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\ShipmentDocumentFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Shipment\NotifierInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Shipment\ShipmentValidatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Shipment\OrderRegistrarInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Sales\Model\Order\Validation\ShipOrderInterface</span> <span class="k">as</span> <span class="nx">ShipOrderValidator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Magento\Framework\App\ObjectManager</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class ShipOrder</span>
<span class="sd"> * @SuppressWarnings(PHPMD.CouplingBetweenObjects)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ShipOrder</span> <span class="k">implements</span> <span class="nx">ShipOrderInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var ResourceConnection</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var ShipmentDocumentFactory</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderStateResolverInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderConfig</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var ShipmentRepositoryInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$shipmentRepository</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var ShipOrderValidator</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$shipOrderValidator</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var NotifierInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$notifierInterface</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var LoggerInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var OrderRegistrarInterface</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$orderRegistrar</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @param ResourceConnection $resourceConnection</span>
<span class="sd">     * @param OrderRepositoryInterface $orderRepository</span>
<span class="sd">     * @param ShipmentDocumentFactory $shipmentDocumentFactory</span>
<span class="sd">     * @param ShipmentValidatorInterface $shipmentValidator</span>
<span class="sd">     * @param OrderValidatorInterface $orderValidator</span>
<span class="sd">     * @param OrderStateResolverInterface $orderStateResolver</span>
<span class="sd">     * @param OrderConfig $config</span>
<span class="sd">     * @param ShipmentRepositoryInterface $shipmentRepository</span>
<span class="sd">     * @param NotifierInterface $notifierInterface</span>
<span class="sd">     * @param OrderRegistrarInterface $orderRegistrar</span>
<span class="sd">     * @param LoggerInterface $logger</span>
<span class="sd">     * @param ShipOrderValidator|null $shipOrderValidator</span>
<span class="sd">     * @SuppressWarnings(PHPMD.ExcessiveParameterList)</span>
<span class="sd">     * @SuppressWarnings(PHPMD.UnusedFormalParameter)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="nx">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="nx">ShipmentDocumentFactory</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">,</span>
        <span class="nx">ShipmentValidatorInterface</span> <span class="nv">$shipmentValidator</span><span class="p">,</span>
        <span class="nx">OrderValidatorInterface</span> <span class="nv">$orderValidator</span><span class="p">,</span>
        <span class="nx">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="nx">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="nx">ShipmentRepositoryInterface</span> <span class="nv">$shipmentRepository</span><span class="p">,</span>
        <span class="nx">NotifierInterface</span> <span class="nv">$notifierInterface</span><span class="p">,</span>
        <span class="nx">OrderRegistrarInterface</span> <span class="nv">$orderRegistrar</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="nx">ShipOrderValidator</span> <span class="nv">$shipOrderValidator</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipmentDocumentFactory</span> <span class="o">=</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipmentRepository</span> <span class="o">=</span> <span class="nv">$shipmentRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifierInterface</span> <span class="o">=</span> <span class="nv">$notifierInterface</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRegistrar</span> <span class="o">=</span> <span class="nv">$orderRegistrar</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipOrderValidator</span> <span class="o">=</span> <span class="nv">$shipOrderValidator</span> <span class="o">?:</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
            <span class="nx">ShipOrderValidator</span><span class="o">::</span><span class="na">class</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @param int $orderId</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentItemCreationInterface[] $items</span>
<span class="sd">     * @param bool $notify</span>
<span class="sd">     * @param bool $appendComment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentCommentCreationInterface|null $comment</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentTrackCreationInterface[] $tracks</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentPackageCreationInterface[] $packages</span>
<span class="sd">     * @param \Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface|null $arguments</span>
<span class="sd">     * @return int</span>
<span class="sd">     * @throws \Magento\Sales\Api\Exception\DocumentValidationExceptionInterface</span>
<span class="sd">     * @throws \Magento\Sales\Api\Exception\CouldNotShipExceptionInterface</span>
<span class="sd">     * @throws \Magento\Framework\Exception\InputException</span>
<span class="sd">     * @throws \Magento\Framework\Exception\NoSuchEntityException</span>
<span class="sd">     * @throws \DomainException</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
        <span class="nx">\Magento\Sales\Api\Data\ShipmentCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$tracks</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="k">array</span> <span class="nv">$packages</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">\Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resourceConnection</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">(</span><span class="s1">&#39;sales&#39;</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$shipment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipmentDocumentFactory</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$tracks</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$packages</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipOrderValidator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$shipment</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$tracks</span><span class="p">,</span>
            <span class="nv">$packages</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s2">&quot;Shipment Document Validation Error(s):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRegistrar</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$shipment</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderStateResolver</span><span class="o">-&gt;</span><span class="na">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[</span><span class="nx">OrderStateResolverInterface</span><span class="o">::</span><span class="na">IN_PROGRESS</span><span class="p">])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="na">getState</span><span class="p">()));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shipmentRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$shipment</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orderRepository</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Magento\Sales\Exception\CouldNotShipException</span><span class="p">(</span>
                <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Could not save a shipment, see error log for details&#39;</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">notifierInterface</span><span class="o">-&gt;</span><span class="na">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$shipment</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$shipment</span><span class="o">-&gt;</span><span class="na">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="exceptions-3">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Creditmemo Document Validation Error(s):\nWe can&#39;t create creditmemo for the order.\nThe most money available to refund is 0.&quot;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="extension-points-3">Extension points</h4>

<p>The service contains extension points marked with <code>@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/ShipmentRepositoryInterface.php" target="_blank"><code>\Magento\Sales\Api\ShipmentRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Shipments.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/ShipmentDocumentFactory.php" target="_blank"><code>\Magento\Sales\Model\Order\ShipmentDocumentFactory</code></a></td>
      <td>A factory creating a Shipment data object. The factory uses the <code>arguments</code> parameter to process the extension attributes of a new shipment document.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Shipment\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Shipment creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/ShipOrderInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Validation\ShipOrderInterface</code></a></td>
      <td>An interface for validating the service parameters and created Shipment data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/OrderRegistrarInterface.php" target="_blank"><code>\Magento\Sales\Model\Order\Shipment\OrderRegistrarInterface</code></a></td>
      <td>An interface for registering a Shipment in Order to update amount of shipped items in a given Order according to Shipment. The <code>execute</code> method returns an updated Order.</td>
    </tr>
  </tbody>
</table>

<!-- LINK DEFINITIONS -->


		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

			

			
			 <div class="github-link">
				 <a class="improve-page" href="https://github.com/magento/devdocs/tree/develop/guides/v2.1/mrg/ce/Sales/services.md" target="_blank">
					 Edit this page on GitHub
				 </a>
			 </div>
			

			<div class="new-issue">
				<a href="https://github.com/magento/devdocs/issues/new?title=&body=Feedback on page: /guides/v2.1/mrg/ce/Sales/services.html" target="_blank">Give us feedback</a>
			</div>

		</div>

	</section>
	<!-- /.content -->

</div> <!-- /.container -->


	</div>
	<!-- /.main-container -->

</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div id="footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav">
				<li><a href="/guides/v2.1/contributor-guide/contributing_docs.html">Become a Contributor</a>
        <li><a href="http://magento.com/legal/terms/privacy/">Privacy Policy</a></li>
        <li><a href="http://magento.com/legal/terms/">Terms of Service</a></li>
        <li><a href="http://magento.com/legal/licensing/">License/Trademark FAQ</a></li>
        <li><a href="/guides/v2.1/release-notes/bk-release-notes.html">Release Notes</a></li>
				<li><a href="/magento-third-party.html">Third-Party Licenses</a></li>
      </ul>
    </div>

		<div class="copyright-date">&copy; 2017 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="/common/js/app.min.js"></script>

<script type="text/javascript">
    (function() {
        var didInit = false;
        function initMunchkin() {
            if(didInit === false) {
                didInit = true;
                Munchkin.init('585-GGD-959', {cookieAnon: false});
            }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
            if (this.readyState == 'complete' || this.readyState == 'loaded') {
                initMunchkin();
            }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>



<!--Google Analytics-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-66243208-1', 'auto');
    ga('send', 'pageview');
</script>


</body>
</html>


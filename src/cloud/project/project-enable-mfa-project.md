---
group: cloud-guide
title: Enable MFA enforcement for SSH access
functional_areas:
  - Cloud
  - Configuration
---

For added security, {{site.data.var.ece}} provides a mutlitfactor authentication (MFA) enforcement feature to manage multifactor authentication requirements for SSH access to Cloud infrastructure.

When this feature is enabled on a project, any user or machine account establishing an SSH connection to an environment must follow an authentication workflow that requires a two-factor authentication (2FA) code and an SSH certificate, or an API token to access the environment.

{:.bs.callout-important}
The MFA enforcement feature is not enabled by default on {{site.data.var.ece}} projects. You must submit a Magento support ticket to request 2FA enablement on your project. After enablement, all subsequent SSH connection requests require either a 2FA token or an API token.

## Certificates for SSH access

The MFA enforcement feature allows users to exchange an OAUTH access token with a short-lived SSH certificate generated by the Magento Cloud Certifier API.

If the user accessing the environment has project Admin or contributor access, a valid SSH key, and a valid 2FA code, {{site.data.var.ece}} uses these credentials to generate the temporary SSH certificate. The certificate expiration is set to 1 hour, but it refreshes automatically during the current session.

After logging into a project with MFA enforcement, users must run the following command to generate the certificate:

```bash
magento-cloud ssh-cert:load
```

This command generates the SSH certificate and installs it in the SSH agent of the local user.

## Connect to an environment using SSH with 2FA

When MFA enforcement is enabled on a {{site.data.var.ece}} project, any user that connects to a Cloud environment using SSH must have 2FA enabled on their account. See [Enable 2FA][].

**Prerequisites:**

For {{site.data.var.ece}} projects enabled for MFA enforcement, SSH access requires the following permissions and account settings:

-  [Admin or contributor access to the {{site.data.var.ece}} environment][Manage user access]
-  [SSH access key configured on account][add public SSH key]
-  [2FA enabled on account][]

{:.procedure}
To connect using SSH with 2FA user account credentials:

1. Log in to your {{site.data.var.ece}} account and authenticate using 2FA.

1. After logging in, open a command line and run the following command to generate the certificate.

   ```bash
   magento-cloud ssh-cert:load
   ```

   ```terminal
   Generating SSH certificate...
     Expires at: 2020-07-13T15:28:13-04:00
     Multi-factor authentication: verified
     Mode: interactive
   The certificate will be automatically refreshed when necessary.
   Checking SSH configuration file: /Users/<user-name>/.ssh/config
   Do you want to update the file automatically? [Y/n] Y
   Configuration file updated successfully: /Users/<user-name>/.ssh/config
   ```

1. Connect to the project using SSH:

   ```bash
   ssh gbhzpx7xmpule-master-7rqtwti--mymagento@ssh.us-3.magento.cloud
   ```

   ```terminal
    __  __                   _          ___ _             _
   |  \/  |__ _ __ _ ___ _ _| |_ ___   / __| |___ _  _ __| |
   | |\/| / _` / _` / -_) ' \  _/ _ \ | (__| / _ \ || / _` |
   |_|  |_\__,_\__, \___|_||_\__\___/  \___|_\___/\_,_\__,_|
               |___/

    Welcome to Magento Cloud.

    This is environment master-7rqtwti
    of project gbhzpx7xmpule.

   web@mymagento.0:~$
   ```

If your request does not provide a valid certificate, a message similar to the following displays:

```terminal
Hello user-test (UUID: abaacca12-5cd1-4b123-9096-411add578998), you successfully
authenticated, but could not connect to service abcdef7uyxabce-master-7rqtabc--mymagento@ssh.us-3.magento.cloud:> (reason: access requires MFA)
```

To resolve this issue, verify that you have 2FA on your account. Also, try regenerating the certificate using the `magento-cloud ssh-cert:load` command.

## Connect to an environment using SSH with API token

When MFA enforcement is enabled on a {{site.data.var.ece}} project, automated processes that require SSH access to a Cloud environment must authenticate using an API token.

The API token allows the SSH connection request to bypass the user authentication flow that requires a 2FA token and SSH certificate. You generate the token from a {{site.data.var.ece}} account with Admin or Contributor access on the project.

**Prerequisites:**

-  [Admin or contributor access to the {{site.data.var.ece}} environment][Manage user access]
-  [Valid API token available on account][Create an API token]

{:.procedure}
To connect using SSH with an API token credential:

1. Log in to the Cloud project using API key authentication, supplying a valid API token when prompted:

   ```bash
   magento-cloud auth:api-token
   ```

  ```terminal
  Please enter an API token:
  >

  The API token is valid.
  You are logged in.
  ```

<!--Link references-->
[Manage user access]: {{ site.baseurl }}/cloud/project/user-admin.html
[Enable 2FA]: {{ site.baseurl }}/cloud/project/user-admin.html
[add public ssh key]: {{site.baseurl}}/cloud/before/before-workspace-ssh.html#ssh-add-to-account
[2FA enabled on account]: {{ site.baseurl }}/cloud/project/user-admin.html#enable-2fa
[Create an API token]: {{ site.baseurl }}/cloud/project/user-admin.html#create-an-api-token

---
group: cloud-guide
title: Enable MFA enforcement for SSH access
functional_areas:
  - Cloud
  - Configuration
  - Security
  - Compliance
  
redirect_from:
  - /cloud/project/project-enable-mfa-project.html
---

{%include cloud/beta-release-content-warning.md%}

For added security, {{site.data.var.ece}} provides mutltifactor authentication (MFA) enforcement to manage authentication requirements for SSH access to Cloud environments.

When MFA enforcement is enabled on a project, all {{site.data.var.ece}} accounts with SSH access must follow an authentication workflow that requires a two-factor authentication (2FA) code and an SSH certificate, or an API token to access the environment.

{:.bs.callout-important}
MFA enforcement is not enabled on Cloud projects by default. You must submit a Magento support request to enable it. As soon as MFA enforcement is turned on, all users must have two-factor authentication (TFA) enabled on their {{ site.data.var.ece }} account for SSH access to the environment.

## Certificates for SSH access

The MFA enforcement feature allows users to exchange an OAUTH access token with a short-lived SSH certificate generated by the Magento Cloud Certifier API.

If the user accessing the environment has the Admin or Contributor role, a valid SSH key, and a valid 2FA code, {{site.data.var.ece}} uses these credentials to generate the temporary SSH certificate. The certificate expiration is set to 1 hour, but it refreshes automatically during the current session.

After logging into a project with MFA enforcement, users must use the CLI to generate the SSH certificate:

```bash
magento-cloud ssh-cert:load
```

The `ssh-cert:load` command generates the SSH certificate and installs it in the SSH agent of the local user.

{:.bs-callout-tip}
You can streamline the authentication process by using an API token for authentication. With an API token, you can skip loading the SSH certificate. See [Connect with an API token](#connect-to-an-environment-using-ssh-with-api-token).

## Connect to an environment using SSH with 2FA

When MFA enforcement is enabled on a {{site.data.var.ece}} project, any user that connects to a Cloud environment using SSH must have 2FA enabled on their account. See [Enable 2FA][].

**Prerequisites:**

For {{site.data.var.ece}} projects enabled for MFA enforcement, SSH access requires the following permissions and account settings:

-  [Admin or contributor access to the {{site.data.var.ece}} environment][Manage user access]
-  [SSH access key configured on account][add public SSH key]
-  [2FA enabled on account][Enable 2FA]

{:.procedure}
To connect using SSH with 2FA user account credentials:

1. Log in to your {{site.data.var.ece}} account and authenticate using 2FA.

1. On your local workstation, use the CLI to generate the SSH certificate.

   ```bash
   magento-cloud ssh-cert:load
   ```

   ```terminal
   Generating SSH certificate...
     Expires at: 2020-07-13T15:28:13-04:00
     Multi-factor authentication: verified
     Mode: interactive
   The certificate will be automatically refreshed when necessary.
   Checking SSH configuration file: /Users/<user-name>/.ssh/config
   Do you want to update the file automatically? [Y/n] Y
   Configuration file updated successfully: /Users/<user-name>/.ssh/config
   ```

1. Connect to the Cloud environment using SSH:

   ```bash
   ssh gbhzpx7xmpule-master-7rqtwti--mymagento@ssh.us-3.magento.cloud
   ```

   ```terminal
    __  __                   _          ___ _             _
   |  \/  |__ _ __ _ ___ _ _| |_ ___   / __| |___ _  _ __| |
   | |\/| / _` / _` / -_) ' \  _/ _ \ | (__| / _ \ || / _` |
   |_|  |_\__,_\__, \___|_||_\__\___/  \___|_\___/\_,_\__,_|
               |___/

    Welcome to Magento Cloud.

    This is environment master-7rqtabc
    of project abcdef7uyxabce.

   web@mymagento.0:~$
   ```

### Troubleshooting

If your request does not provide a valid certificate, a message similar to the following displays:

```terminal
Hello user-test (UUID: abaacca12-5cd1-4b123-9096-411add578998), you successfully
authenticated, but could not connect to service abcdef7uyxabce-master-7rqtabc--mymagento@ssh.us-3.magento.cloud:>
(reason: access requires MFA)
```

Try the following troubleshooting procedures to resolve the connection issue:

-  Verify the account TFA configuration
-  Authenticate again, and then reload the certificate

{:.procedure}
To verify TFA configuration and authentication:

1. On your [Cloud account][Cloud account page], click **Account settings** > **Security**.

   If TFA is enabled, the Security section provides options to manage the TFA configuration:

   ![Cloud manage TFA config]({{ site.baseurl }}/common/images/cloud/cloud-account-settings-manage-2fa-config.png){:width="550px"}

1. If TFA is not set up, click **Set up application** and follow the instructions to enable it. See [Enable 2FA][].

1. If TFA is configured, try authenticating again.

{:.procedure}
To authenticate and reload the SSH certificate:

1. Use the Magento Cloud CLI to authenticate again:

   ```bash
   magento-cloud logout
   ```

   ```bash
   magento-cloud login
   ```

1. Reload the SSH certificate:

   ```bash
   magento-cloud ssh-cert:load
   ```

## Connect to an environment using SSH with API token

When MFA enforcement is enabled on a {{site.data.var.ece}} project, automated processes that require SSH access to a Cloud environment must authenticate using an API token.

The API token allows the SSH connection request to bypass the user authentication flow that requires a 2FA token and SSH certificate. You generate the token from a {{site.data.var.ece}} account with Admin or Contributor access on the project.

**Prerequisites:**

-  [Admin or Contributor access to the {{site.data.var.ece}} environment][Manage user access]
-  [Valid API token available on account][Create an API token]

{:.procedure}
To connect using SSH with an API token credential:

1. Log in to the Cloud project using API key authentication.

   ```bash
   magento-cloud auth:api-token
   ```
1. At the prompt, enter the value for a valid API token.

   ```terminal
   Please enter an API token:
   >

   The API token is valid.
   You are logged in.
   ```

<!--Link references-->
[add public ssh key]: {{ site.baseurl }}/cloud/before/before-workspace-ssh.html#ssh-add-to-account
[Cloud account page]: https://accounts.magento.cloud/user
[Create an API token]: {{ site.baseurl }}/cloud/project/user-admin.html#create-an-api-token
[Enable 2FA]: {{ site.baseurl }}/cloud/project/user-admin.html#enable-2fa-for-cloud-accounts
[Manage user access]: {{ site.baseurl }}/cloud/project/user-admin.html
